# PromptOps Billing Setup Guide

This guide will help you set up the complete billing system for PromptOps using Stripe.

## ðŸš€ Quick Setup

### 1. Prerequisites
- Stripe account (test mode for development)
- Supabase project with the updated schema
- Environment variables configured

### 2. Update Database Schema

Run the updated `SQLSUPABASE.sql` file in your Supabase SQL editor to add the required Stripe fields:

```sql
-- The schema now includes:
stripe_customer_id TEXT,
stripe_subscription_id TEXT,
subscription_status TEXT DEFAULT 'inactive',
subscription_current_period_end TIMESTAMP WITH TIME ZONE,
api_calls_used INTEGER DEFAULT 0 NOT NULL,
```

### 3. Configure Environment Variables

Your `.env` file should include:

```env
# Stripe Configuration
STRIPE_SECRET_KEY=sk_test_your_stripe_secret_key
VITE_STRIPE_PUBLIC_KEY=pk_test_your_stripe_public_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret
CLIENT_URL=http://localhost:5000

# These will be generated by the setup script:
STRIPE_PRO_PRICE_ID=price_test_pro_monthly
STRIPE_TEAM_PRICE_ID=price_test_team_monthly
STRIPE_ENTERPRISE_PRICE_ID=price_test_enterprise_monthly
```

### 4. Create Stripe Products

Run the setup script to create products and prices in Stripe:

```bash
npm install stripe
node scripts/setup-stripe-products.js
```

This will create:
- **Pro Plan**: $19/month (1000 prompts, 150 enhancements)
- **Team Plan**: $49/month (7500 prompts, 2000 enhancements)
- **Enterprise Plan**: $99/month (Unlimited)

### 5. Set Up Stripe Webhook

1. Go to your [Stripe Dashboard](https://dashboard.stripe.com/webhooks)
2. Click "Add endpoint"
3. Set the endpoint URL to: `https://yourdomain.com/api/stripe-webhook`
4. Select these events:
   - `checkout.session.completed`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
5. Copy the webhook secret and add it to your `.env` file

## ðŸŽ¯ Features Included

### âœ… Subscription Management
- **Create Subscriptions**: Stripe Checkout integration
- **Cancel Subscriptions**: Cancel at period end
- **Reactivate Subscriptions**: Undo cancellation
- **Customer Portal**: Stripe-hosted billing management

### âœ… Usage Tracking
- **API Calls**: Track prompt tests and AI enhancements
- **Plan Limits**: Enforce usage limits based on subscription
- **Real-time Updates**: Live usage tracking in dashboard

### âœ… Billing Pages
- **Pricing Cards**: Interactive plan selection
- **Subscription Status**: Current plan and billing info
- **Billing History**: Transaction history (via Stripe portal)
- **Usage Warnings**: Alerts when approaching limits

## ðŸ”§ API Endpoints

### Billing Endpoints
- `POST /api/create-checkout-session` - Create Stripe checkout
- `GET /api/subscription` - Get subscription details
- `POST /api/create-portal-session` - Open Stripe customer portal
- `POST /api/cancel-subscription` - Cancel subscription
- `POST /api/reactivate-subscription` - Reactivate subscription
- `POST /api/stripe-webhook` - Handle Stripe webhooks

### Usage Endpoints
- `GET /api/user/usage` - Get current usage and limits
- `POST /api/test-prompt` - Test prompt (counts against usage)
- `POST /api/enhance-prompt` - Enhance prompt (counts against usage)

## ðŸ§ª Testing

### Test Cards (Stripe Test Mode)
- **Success**: `4242 4242 4242 4242`
- **Decline**: `4000 0000 0000 0002`
- **3D Secure**: `4000 0025 0000 3155`

### Test Scenarios
1. **Upgrade Flow**: Free â†’ Pro â†’ Team â†’ Enterprise
2. **Cancellation**: Cancel subscription, verify access until period end
3. **Reactivation**: Cancel then reactivate before period end
4. **Usage Limits**: Test enforcement of plan limits
5. **Webhooks**: Verify webhook handling for all events

## ðŸš¨ Important Notes

### Security
- Never expose `STRIPE_SECRET_KEY` in client-side code
- Always validate webhooks with the webhook secret
- Use HTTPS in production for webhook endpoints

### Production Setup
1. Switch to Stripe live mode
2. Update environment variables with live keys
3. Set up production webhook endpoint
4. Test the complete flow with real payments

### Troubleshooting
- Check Stripe logs for webhook delivery issues
- Verify environment variables are loaded correctly
- Ensure database schema is up to date
- Check browser console for client-side errors

## ðŸ“± User Experience

### Free Plan Users
- Can test up to 15 prompts per month
- See upgrade prompts when approaching limits
- Clear pricing information on billing page

### Paid Plan Users
- Seamless checkout experience
- Real-time usage tracking
- Easy subscription management
- Access to customer portal for billing changes

### Admin Features
- Webhook monitoring
- Usage analytics
- Subscription status tracking
- Revenue reporting (via Stripe Dashboard)

## ðŸŽ‰ Ready to Go!

After completing this setup:
1. Users can upgrade their plans seamlessly
2. Usage is tracked and enforced automatically
3. Billing is handled entirely by Stripe
4. Subscription management is self-service
5. Revenue tracking is available in Stripe Dashboard

The billing system is now fully functional and production-ready! ðŸš€
